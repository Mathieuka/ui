import { ArgsTable, Meta, Story, Canvas, Preview, Props } from '@storybook/addon-docs'
import { Prism as SyntaxHighlighter } from 'react-syntax-highlighter'
import { Faucet } from 'ui/organisms/faucet/Faucet'
import { ThemeProvider } from 'ui/atoms/theme/ThemeProvider'
import { ThemeSwitcher } from 'ui/atoms/theme/ThemeSwitcher'
import { StoreProvider } from 'ui/providers/storeProvider'
import cosmosDark from 'assets/images/cosmos-dark.png'
import cosmosLight from 'assets/images/cosmos-clear.png'
import { useTheme } from 'hook/useTheme'
import { default as storeParameters } from './store'
import * as env from './env.json'

<Meta
  title="Organisms/Faucet"
  component={Faucet}
  parameters={{
    actions: { argTypesRegex: '^on.*' },
    docs: {
      source: {
        type: 'code'
      }
    }
  }}
  decorators={[
    Story => (
      <ThemeProvider>
        <StoreProvider storeParameters={storeParameters}>
          <div className="component-story-main faucet">
            <ThemeSwitcher />
            <Story />
          </div>
        </StoreProvider>
      </ThemeProvider>
    )
  ]}
/>

# OKP4 Faucet

> Request funds from OKP4 official Testnet.

[![stability-unstable](https://img.shields.io/badge/stability-unstable-yellow.svg)](https://github.com/emersion/stability-badges#unstable)

## Description

The OKP4 Faucet allows a user to request funds from the official OKP4 Testnet.  
You'll receive 1 KNOW per request, with a maximum of 1 request each 5 seconds.  
To do this, you just need to enter your OKP4 address or connect via [Keplr](https://chrome.google.com/webstore/detail/keplr/dmkamcknogkgcdfhhbddcghachkejeap), the OKP4 wallet!

## Overview

<Story
  name="Overview"
  args={{ chainId: env.chainId }}
  parameters={{ docs: { source: { type: 'code', langauge: 'jsx', format: true } } }}
>
  {args => {
    const { theme } = useTheme()
    return (
      <div
        style={{
          display: 'flex',
          alignSelf: 'center',
          minHeight: '500px',
          backgroundImage: `url(${theme === 'dark' ? cosmosDark : cosmosLight})`,
          backgroundSize: 'contain',
          backgroundRepeat: 'no-repeat'
        }}
      >
        <Faucet {...args} />
      </div>
    )
  }}
</Story>

## Usage

The `Faucet` organism is a React component that embeds all the business logic associated in particular with the connection to the Keplr wallet as well as the request to the OKP4 blockchain.  
To configure the component, everything is provided by the `@okp4/ui` library and the below examples, you will simply have to follow those 3 steps:

### 1. Create a `config.json` file that declares the OKP4 blockchain config

This file contains all the information the component needs to configure itself.
This also includes the configuration needed to add the OKP4 blockchain to the Keplr wallet.

##### **`config.json`**

```json
{
  "chainId": "okp4-devnet-1",
  "chainName": "OKP4",
  "rpc": "https://api.devnet.okp4.network:443/rpc",
  "rest": "https://api.devnet.okp4.network",
  "bip44": {
    "coinType": 118
  },
  "bech32Config": {
    "bech32PrefixAccAddr": "okp4",
    "bech32PrefixAccPub": "okp4pub",
    "bech32PrefixValAddr": "okp4valoper",
    "bech32PrefixValPub": "okp4valoperpub",
    "bech32PrefixConsAddr": "okp4valcons",
    "bech32PrefixConsPub": "okp4valconspub"
  },
  "currencies": [
    {
      "coinDenom": "KNOW",
      "coinMinimalDenom": "uknow",
      "coinDecimals": 6
    }
  ],
  "feeCurrencies": [
    {
      "coinDenom": "KNOW",
      "coinMinimalDenom": "uknow",
      "coinDecimals": 6
    }
  ],
  "stakeCurrency": {
    "coinDenom": "KNOW",
    "coinMinimalDenom": "uknow",
    "coinDecimals": 6
  },
  "coinType": 118,
  "gasPriceStep": {
    "low": 0.01,
    "average": 0.025,
    "high": 0.03
  }
}
```

### 2. Instanciate redux stores to init the component

##### **`store.ts`**

To work, the component uses [redux](https://redux.js.org/) as a state manager and an `eventBus` instance to facilitate communication between the business domains.  
To do this, all you have to do is declare the store parameters in a `store.ts` file to be able to import them later into a `Provider` component that will take care of injecting them into the React context.

```ts
import { List } from 'immutable'
import {
  createEventBusInstance,
  HTTPFaucetGateway,
  ErrorStoreBuilder,
  FaucetStoreBuilder,
  FaucetContext,
  ErrorContext,
  KeplrWalletGateway,
  TaskContext,
  TaskStoreBuilder,
  WalletContext,
  WalletRegistryGateway,
  WalletStoreBuilder
} from '@okp4/ui'
import type { StoreParameter } from '@okp4/ui'
import * as config from './config.json'

/** Init an eventBus instance
 * Needed to enable communication and reactivity beetwen business domains
 */
const eventBusInstance = createEventBusInstance()

/** Init Faucet Gateway & redux store
 * The heart of Faucet behaviour
 */
const faucetGateway = new HTTPFaucetGateway(config.faucetUrl)
const faucetStore = new FaucetStoreBuilder()
  .withEventBus(eventBusInstance)
  .withDependencies({ faucetGateway })
  .build()
const faucetStoreParameter: StoreParameter = [FaucetContext, faucetStore]

/** Init Error redux store
 * Needed to handle errors thrown by other domains
 */
const errorStore = new ErrorStoreBuilder().withEventBus(eventBusInstance).build()
const errorStoreParameter: StoreParameter = [ErrorContext, errorStore]

/** Init Task redux store
 * Needed to handle asynchronous tasks fired by other domains
 */
const taskStore = new TaskStoreBuilder().withEventBus(eventBusInstance).build()
const taskStoreParameter: StoreParameter = [TaskContext, taskStore]

/** Init Wallet Gateway & redux store
 * Needed to handle Keplr wallet
 */
const walletRegistryGateway = new WalletRegistryGateway()
const keplrGateway = new KeplrWalletGateway(config.kepkrChainInfo)
walletRegistryGateway.register(keplrGateway)
const walletStore = new WalletStoreBuilder()
  .withEventBus(eventBusInstance)
  .withDependencies({ walletRegistryGateway })
  .build()
const walletStoreParameter: StoreParameter = [WalletContext, walletStore]

/** Export store parameters as following: [StoreContext, StoreInstance]
 * Will be auto-injected in React context through <StoreProvider> props
 */
export default List([
  faucetStoreParameter,
  errorStoreParameter,
  walletStoreParameter,
  taskStoreParameter
])
```

### 3. Wrap the `Faucet` component into a store provider

Finally, it is necessary to wrap the `Faucet` component in a `StoreProvider` which will auto-inject into the React context the configuration elements necessary for its proper functioning.
This `StoreProvider` component is directly provided by the `@okp4/ui` library, you simply have to pass it the parameters exported by the `store.ts` file as properties.

##### **`app.tsx`**

```tsx
import React from 'react'
import { Faucet, StoreProvider } from '@okp4/ui'
import * as storeParameters from './store'
import * as config from './config.json'

export const App: React.FC = () => (
  <StoreProvider storeParameters={storeParameters}>
    <Faucet chainId={config.chainId} />
  </StoreProvider>
)
```

And, that's it!
You have to create or import an account within Keplr extension and everything else is handled by the component itself ðŸš€

## Notes

- Keep in mind that the OKP4 Faucet is only available within a `testnet` environment, it cannot be used in the `mainnet` environment to get some KNOW ðŸ˜‰
- The Keplr extension is only available for now in Chrome browser, watch out for other extensions with the same name but which are scams trying to access your mnemonics...
- This tool is an opensource project offered to the community, feel free to visit the official [Faucet](https://github.com/okp4/faucet-web) GitHub for a more polished example and contribute if you have any feature ideas or a bug to fix!
