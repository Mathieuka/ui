import { ArgsTable, Meta, Story, Canvas, Preview, Props } from '@storybook/addon-docs'
import { Prism as SyntaxHighlighter } from 'react-syntax-highlighter'
import { Faucet } from 'ui/organisms/faucet/Faucet'
import { ThemeProvider } from 'ui/atoms/theme/ThemeProvider'
import { ThemeSwitcher } from 'ui/atoms/theme/ThemeSwitcher'
import { StoreProvider } from 'ui/providers/storeProvider'
import cosmosDark from 'assets/images/cosmos-dark.png'
import cosmosLight from 'assets/images/cosmos-clear.png'
import { useTheme } from 'hook/useTheme'
import { default as storeParameters } from './store'
import * as env from './env.json'

<Meta
  title="Organisms/Faucet"
  component={Faucet}
  parameters={{
    actions: { argTypesRegex: '^on.*' },
    docs: {
      source: {
        type: 'code'
      }
    }
  }}
  decorators={[
    Story => (
      <ThemeProvider>
        <StoreProvider storeParameters={storeParameters}>
          <div className="component-story-main faucet">
            <ThemeSwitcher />
            <Story />
          </div>
        </StoreProvider>
      </ThemeProvider>
    )
  ]}
/>

# OKP4 Faucet

> Request funds from OKP4 official Testnet.

[![stability-unstable](https://img.shields.io/badge/stability-unstable-yellow.svg)](https://github.com/emersion/stability-badges#unstable)

## Overview

The OKP4 Faucet allows a user to request funds from the official OKP4 Testnet.  
You'll receive 1 KNOW per request, with a maximum of 1 request each 5 seconds.  
To do this, you just need to enter your OKP4 address or connect via [Keplr](https://chrome.google.com/webstore/detail/keplr/dmkamcknogkgcdfhhbddcghachkejeap), the OKP4 wallet!

---

<Story
  name="Overview"
  argTypes={{}}
  args={{ chainId: env.chainId }}
  parameters={{ docs: { source: { type: 'code', langauge: 'jsx', format: true } } }}
>
  {args => {
    const { theme } = useTheme()
    return (
      <div
        style={{
          display: 'flex',
          alignSelf: 'center',
          minHeight: '500px',
          backgroundImage: `url(${theme === 'dark' ? cosmosDark : cosmosLight})`,
          backgroundSize: 'contain',
          backgroundRepeat: 'no-repeat'
        }}
      >
        <Faucet {...args} />
      </div>
    )
  }}
</Story>

## Usage

The `Faucet` organism is a React component that embeds all the business logic associated in particular with the connection to the Keplr wallet as well as the request to the OKP4 blockchain.  
To configure the component, everything is provided by the `@okp4/ui` library and the below examples, you will simply have to follow those 3 steps:

### 1. Create a `config.json` file that declares the OKP4 blockchain config

##### **`config.json`**

```json
{
  "chainId": "okp4-devnet-1",
  "chainName": "OKP4",
  "rpc": "https://api.devnet.okp4.network:443/rpc",
  "rest": "https://api.devnet.okp4.network",
  "bip44": {
    "coinType": 118
  },
  "bech32Config": {
    "bech32PrefixAccAddr": "okp4",
    "bech32PrefixAccPub": "okp4pub",
    "bech32PrefixValAddr": "okp4valoper",
    "bech32PrefixValPub": "okp4valoperpub",
    "bech32PrefixConsAddr": "okp4valcons",
    "bech32PrefixConsPub": "okp4valconspub"
  },
  "currencies": [
    {
      "coinDenom": "KNOW",
      "coinMinimalDenom": "uknow",
      "coinDecimals": 6
    }
  ],
  "feeCurrencies": [
    {
      "coinDenom": "KNOW",
      "coinMinimalDenom": "uknow",
      "coinDecimals": 6
    }
  ],
  "stakeCurrency": {
    "coinDenom": "KNOW",
    "coinMinimalDenom": "uknow",
    "coinDecimals": 6
  },
  "coinType": 118,
  "gasPriceStep": {
    "low": 0.01,
    "average": 0.025,
    "high": 0.03
  }
}
```

### 2. Instanciate redux stores to init the component

##### **`store.ts`**

```ts
import { List } from 'immutable'
import {
  createEventBusInstance,
  HTTPFaucetGateway,
  ErrorStoreBuilder,
  FaucetStoreBuilder,
  FaucetContext,
  ErrorContext,
  KeplrWalletGateway,
  TaskContext,
  TaskStoreBuilder,
  WalletContext,
  WalletRegistryGateway,
  WalletStoreBuilder
} from '@okp4/ui'
import type { StoreParameter } from '@okp4/ui'
import * as config from './config.json'

const eventBusInstance = createEventBusInstance()

// Faucet
const faucetGateway = new HTTPFaucetGateway(config.faucetUrl)
const faucetStore = new FaucetStoreBuilder()
  .withEventBus(eventBusInstance)
  .withDependencies({ faucetGateway })
  .build()
const faucetStoreParameter: StoreParameter = [FaucetContext, faucetStore]

// Error
const errorStore = new ErrorStoreBuilder().withEventBus(eventBusInstance).build()
const errorStoreParameter: StoreParameter = [ErrorContext, errorStore]

// Task
const taskStore = new TaskStoreBuilder().withEventBus(eventBusInstance).build()
const taskStoreParameter: StoreParameter = [TaskContext, taskStore]

// Wallet
const walletRegistryGateway = new WalletRegistryGateway()
const keplrGateway = new KeplrWalletGateway(config.kepkrChainInfo)
walletRegistryGateway.register(keplrGateway)
const walletStore = new WalletStoreBuilder()
  .withEventBus(eventBusInstance)
  .withDependencies({ walletRegistryGateway })
  .build()
const walletStoreParameter: StoreParameter = [WalletContext, walletStore]

export default List([
  faucetStoreParameter,
  errorStoreParameter,
  walletStoreParameter,
  taskStoreParameter
])
```

### 3. Wrap the `Faucet` component into a store provider

##### **`app.tsx`**

```tsx
import React from 'react'
import { Faucet, StoreProvider } from '@okp4/ui'
import * as storeParameters from './store'
import * as config from './config.json'

export const App: React.FC = () => (
  <StoreProvider storeParameters={storeParameters}>
    <Faucet chainId={config.chainId} />
  </StoreProvider>
)
```

And, that's it!
You have to create or import an account within Keplr extension and everything else is handled by the component itself ðŸš€

## Notes

- Keep in mind that the OKP4 Faucet is only available within a `testnet` environment, it cannot be used in the `mainnet` environment to get some know ðŸ˜‰
- The Keplr extension is only availbale for now in Chrome browser, watch out for other extensions with the same name but which are scams trying to access your mnemonics...
- This tool is an opensource project offered to the community, feel free to visit the official [Faucet](https://github.com/okp4/faucet-web) GitHub for a more polished example and contribute if you have any feature ideas or a bug to fix!
